# ğŸŒ WireGuard NAT Tunnel

**Run a WireGuard VPN server anywhere (even behind NAT) and make it publicly accessible through a relay server.**

Perfect for home servers, Raspberry Pi, or any VM behind NAT/firewall where you can't open ports directly.

---

## ğŸ¯ What Problem Does This Solve?

**Scenario:** You want to run a personal VPN server at home/office, but:
- âŒ Your server is behind NAT (no public IP)
- âŒ You can't configure port forwarding on the router
- âŒ Your ISP blocks incoming connections
- âŒ You're behind CGNAT (Carrier-Grade NAT)

**Solution:** Use a relay server (VPS with public IP) to tunnel traffic to your VPN server!

---

## ğŸ—ï¸ How It Works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPN Clients â”‚  (Your phone, laptop anywhere in the world)
â”‚ ğŸ“± ğŸ’» ğŸ–¥ï¸   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Connects to relay.example.com:51820
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Relay Server    â”‚  (VPS with public IP)
â”‚  (Port 22)       â”‚  - Forwards VPN traffic via socat
â”‚  â˜ï¸              â”‚  - Forwards SSH via iptables DNAT
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ WireGuard Tunnel (10.9.0.1 â†” 10.9.0.2)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VPN Server        â”‚  (Behind NAT - your home/office)
â”‚  (Port 2222)       â”‚  - Runs WireGuard VPN
â”‚  ğŸ                 â”‚  - Provides internet to VPN clients
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ NAT Masquerade
         â†“
    ğŸŒ Internet
```

**Traffic Flow:**
1. VPN clients connect to `relay.example.com:51820`
2. Relay uses `socat` to forward UDP packets through the WireGuard tunnel
3. VPN server receives packets, processes them, and routes to internet
4. Return traffic follows the reverse path

---

## âœ¨ Features

- âœ… **NAT Traversal** - VPN server works behind any NAT/firewall
- âœ… **No Port Forwarding Needed** - On VPN server side
- âœ… **Dynamic Interface Detection** - Auto-detects eth0/wlan0
- âœ… **SSH Access** - Access VPN server via `relay.example.com:2222`
- âœ… **Production Ready** - Systemd services, auto-restart
- âœ… **Easy Setup** - 2 scripts, 5 minutes
- âœ… **Secure** - WireGuard encryption end-to-end

---

## ğŸ“‹ Prerequisites

### Relay Server (VPS with Public IP)
- Ubuntu/Debian server with public IP
- Root/sudo access
- Ports available: 51820/UDP, 51821/UDP, 2222/TCP
- Router port forwarding configured (if behind router)

### VPN Server (Can be behind NAT)
- Ubuntu/Debian server (Raspberry Pi works great!)
- Root/sudo access
- Can reach internet (outbound connections)
- No inbound ports needed!

### Your Computer
- To run scripts and generate client configs

---

## ğŸš€ Quick Start (5 Minutes)

### Step 1: Configure

```bash
# Clone this repository
git clone https://github.com/yourusername/wireguard-nat-tunnel.git
cd wireguard-nat-tunnel

# Edit config.sh - ONLY 2 REQUIRED CHANGES:
nano config.sh
```

**Minimal config (only change these):**
```bash
RELAY_DOMAIN="your-relay-server.com"    # Your relay's domain/IP
SSH_PASSWORD="YourSecurePassword"       # Change this!
```

That's it! Defaults work for everything else.

### Step 2: Setup Relay Server

```bash
# Copy files to relay server
scp config.sh relay-wireguard-setup.sh user@your-relay-server.com:/tmp/

# SSH to relay and run setup
ssh user@your-relay-server.com
cd /tmp
sudo bash relay-wireguard-setup.sh

# âœ… Copy the relay public key shown at the end
```

### Step 3: Setup VPN Server

```bash
# Copy files to VPN server
scp config.sh pi-wireguard-tunnel-setup.sh user@vpn-server-local-ip:/tmp/

# SSH to VPN server and run setup
ssh user@vpn-server-local-ip
cd /tmp
sudo bash pi-wireguard-tunnel-setup.sh

# âœ… Copy the VPN server public key shown at the end
```

### Step 4: Connect Relay to VPN Server

```bash
# SSH back to relay server
ssh user@your-relay-server.com

# Add VPN server's public key
VPN_KEY="<paste_vpn_server_public_key_here>"
sudo sed -i "s/PLACEHOLDER_PI_PUBLIC_KEY/$VPN_KEY/" /etc/wireguard/wg-tunnel.conf
sudo systemctl restart wg-quick@wg-tunnel

# Verify tunnel is up
sudo wg show wg-tunnel
# Should show "latest handshake: X seconds ago"
```

### Step 5: Generate Client Config

```bash
# On your computer (or relay server)
./generate-phone-qr.sh

# Scan QR code with WireGuard app on your phone!
```

---

## ğŸ“± Connecting Clients

### Mobile (iOS/Android)
1. Install [WireGuard app](https://www.wireguard.com/install/)
2. Scan QR code from `generate-phone-qr.sh`
3. Toggle VPN ON
4. âœ… All traffic routes through your VPN!

### Desktop (Windows/Mac/Linux)
1. Install [WireGuard](https://www.wireguard.com/install/)
2. Import config file generated by script
3. Activate connection

**Endpoint:** `your-relay-server.com:51820`

---

## ğŸ”§ Configuration Reference

### Minimal Setup (Required)
```bash
RELAY_DOMAIN="vpn.example.com"      # Your relay server's public address
SSH_PASSWORD="SecurePassword123"    # SSH password for both servers
```

### Common Customizations
```bash
# Use different VPN network
VPN_NETWORK="10.200.0.0/24"
VPN_GATEWAY="10.200.0.1"

# Use different ports
WIREGUARD_PORT="8443"               # Change if 51820 is blocked
WIREGUARD_TUNNEL_PORT="8444"
SSH_FORWARD_PORT="2200"

# Use Cloudflare DNS instead of Google
VPN_DNS_SERVERS="1.1.1.1, 1.0.0.1"
```

---

## ğŸ› ï¸ Management

### Check Status

**On Relay:**
```bash
sudo wg show wg-tunnel              # Tunnel status
sudo systemctl status wireguard-udp-forward  # socat status
```

**On VPN Server:**
```bash
sudo wg show wg0                    # VPN clients
sudo wg show wg-tunnel              # Tunnel to relay
./diagnose-pi-vpn.sh                # Full diagnostic
```

### Restart Services

**Relay:**
```bash
sudo systemctl restart wg-quick@wg-tunnel
sudo systemctl restart wireguard-udp-forward
```

**VPN Server:**
```bash
sudo systemctl restart wg-quick@wg0
sudo systemctl restart wg-quick@wg-tunnel
```

### Add More Clients

```bash
# Generate new client
./generate-phone-qr.sh

# Or manually add to VPN server's /etc/wireguard/wg0.conf
```

---

## ğŸ› Troubleshooting

### VPN Connects But No Internet

**Check 1: Verify NAT is working**
```bash
# On VPN server
sudo iptables -t nat -L POSTROUTING -n -v | grep MASQUERADE
# Should show packets going through
```

**Check 2: Check forwarding**
```bash
# On VPN server
sudo iptables -L FORWARD -n -v | grep wg0
# Should show packets
```

**Check 3: Disable corporate VPN**
- Nested VPNs cause conflicts!
- Disconnect from work VPN before connecting to your VPN

### Can't Connect to VPN

**Check 1: Relay is reachable**
```bash
nc -zvu your-relay-server.com 51820
# Should say "succeeded"
```

**Check 2: Tunnel is up**
```bash
# On relay
sudo wg show wg-tunnel | grep handshake
# Should show recent handshake
```

**Check 3: socat is running**
```bash
# On relay
sudo systemctl status wireguard-udp-forward
# Should be "active (running)"
```

### SSH to VPN Server Not Working

```bash
# From anywhere
ssh -p 2222 user@your-relay-server.com

# If fails, check DNAT on relay
sudo iptables -t nat -L PREROUTING -n -v | grep 2222
```

---

## ğŸ“Š Network Details

### IP Ranges
- **VPN Client Network:** `10.8.0.0/24` (254 clients)
- **Tunnel Network:** `10.9.0.0/30` (2 IPs)
  - Relay: `10.9.0.1`
  - VPN Server: `10.9.0.2`

### Ports
- **51820/UDP:** VPN client connections (public)
- **51821/UDP:** Relay-to-VPN tunnel (public)
- **2222/TCP:** SSH to VPN server (public)

### Services
- **Relay:** `wg-tunnel`, `wireguard-udp-forward` (socat)
- **VPN Server:** `wg-tunnel`, `wg0`

---

## ğŸ” Security Considerations

- âœ… WireGuard uses state-of-the-art cryptography (Noise protocol)
- âœ… All traffic encrypted end-to-end
- âœ… Change default SSH password in `config.sh`
- âœ… Consider using SSH keys instead of passwords
- âœ… Configure firewall (UFW) on both servers
- âœ… No WireGuard private keys in repository
- âš ï¸ Relay server must be trusted (sees encrypted traffic)

---

## ğŸ¤ Contributing

Contributions welcome! Please open an issue or pull request.

---

## ğŸ“„ License

MIT License - feel free to use for personal or commercial projects.

---

## ğŸ™ Acknowledgments

Built with:
- [WireGuard](https://www.wireguard.com/) - Fast, modern VPN
- [socat](http://www.dest-unreach.org/socat/) - Multipurpose relay

---

## ğŸ“š Learn More

- [WireGuard Documentation](https://www.wireguard.com/quickstart/)
- [How NAT Traversal Works](https://en.wikipedia.org/wiki/NAT_traversal)
- [WireGuard Protocol Paper](https://www.wireguard.com/papers/wireguard.pdf)

---

**ğŸ‰ Enjoy your personal VPN accessible from anywhere!**
